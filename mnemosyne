#!/bin/bash

# mnemosyne - CLI wrapper for Mnemosyne Cluster Management

CMD=$1
ARG=$2

PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$PROJECT_DIR"

show_help() {
    echo "Usage: ./mnemosyne <command> [args]"
    echo ""
    echo "Commands:"
    echo "  start           Start the cluster (docker compose up -d)"
    echo "  stop            Stop the cluster (docker compose down)"
    echo "  restart         Restart the cluster"
    echo "  mount <path>    Mount the WebDAV share to a local folder"
    echo "  unmount         Unmount the WebDAV share"
    echo "  update          Pull latest code (RESET hard) and rebuild"
    echo "  logs <service>  View logs (optional: service name)"
    echo ""
}

# Helper: Unmount safely
do_unmount() {
    # Check if a specific path was given via ARG (global), otherwise auto-detect
    TARGET="$1"
    
    if [ -n "$TARGET" ]; then
         if mount | grep -q "$TARGET"; then
             echo "Unmounting $TARGET..."
             sudo umount "$TARGET"
         fi
    else
        # Auto-detect all mnemosyne mounts
        MOUNT_POINTS=$(mount | grep "localhost:8080/archive" | awk '{print $3}')
        for MP in $MOUNT_POINTS; do
            echo "Auto-unmounting: $MP"
            sudo umount "$MP"
        done
    fi
}

# Helper: Remount paths (passed as space-separated string)
do_remount() {
    MOUNTS="$1"
    for MP in $MOUNTS; do
        if [ -n "$MP" ]; then
            echo "Restoring mount at $MP..."
            # Use the optimized mount flags
            sudo mount -t davfs -o uid=$(id -un),gid=$(id -gn),use_locks=0 http://localhost:8080/archive "$MP"
        fi
    done
}

case "$CMD" in
    start)
        echo "Starting Mnemosyne..."
        docker compose up -d --build --remove-orphans
        ;;
    stop)
        echo "Stopping Mnemosyne..."
        do_unmount
        docker compose down
        ;;
    restart)
        # Capture current mounts before we kill them
        DETECTED_MOUNTS=$(mount | grep "localhost:8080/archive" | awk '{print $3}')
        
        echo "Restarting Mnemosyne..."
        do_unmount
        docker compose restart
        
        # Restore mounts
        do_remount "$DETECTED_MOUNTS"
        ;;
    mount)
        if [ -z "$ARG" ]; then
            echo "Error: details directory required."
            echo "Usage: ./mnemosyne mount /path/to/folder"
            exit 1
        fi
        
        # Check for davfs2
        if ! command -v mount.davfs &> /dev/null; then
            echo "Error: davfs2 not installed. Run: sudo apt install davfs2"
            exit 1
        fi

        echo "Creating mount point at $ARG..."
        sudo mkdir -p "$ARG"

        # OPTIMIZATION: Configure davfs2 for "Real-Time" Sync (No Caching)
        mkdir -p "$HOME/.davfs2"
        CONF_FILE="$HOME/.davfs2/davfs2.conf"
        
        if [ ! -f "$CONF_FILE" ]; then
            echo "Creating optimized davfs2 config at $CONF_FILE..."
            echo "cache_size 0" > "$CONF_FILE"
            echo "delay_upload 0" >> "$CONF_FILE"
            echo "use_locks 0" >> "$CONF_FILE" 
            echo "gui_optimize 1" >> "$CONF_FILE"
        fi
        
        echo "Mounting http://localhost:8080/archive to $ARG..."
        sudo mount -t davfs -o uid=$(id -un),gid=$(id -gn),use_locks=0 http://localhost:8080/archive "$ARG"
        echo "Success! Mounted at $ARG (Cache Optimized)"
        ;;
    unmount)
        do_unmount "$ARG"
        echo "Done."
        ;;
    update)
        echo "WARNING: This will RESET your local code to match the remote repository."
        echo "Your .env and data/ folder will be preserved."
        read -p "Are you sure? (y/N) " CONFIRM
        if [[ "$CONFIRM" =~ ^[Yy]$ ]]; then
            # Capture mounts
            DETECTED_MOUNTS=$(mount | grep "localhost:8080/archive" | awk '{print $3}')
            
            echo "Unmounting before update..."
            do_unmount

            echo "Fetching latest code..."
            git fetch origin
            git reset --hard origin/master
            
            echo "Rebuilding containers..."
            docker compose up -d --build --remove-orphans
            
            # Restore mounts
            do_remount "$DETECTED_MOUNTS"
            
            echo "Update Complete."
        else
             echo "Update cancelled."
        fi
        ;;
    logs)
        if [ -z "$ARG" ]; then
            docker compose logs -f --tail=100
        else
            docker compose logs -f --tail=100 "$ARG"
        fi
        ;;
    *)
        show_help
        exit 1
        ;;
esac
